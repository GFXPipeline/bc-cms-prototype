# bc-cms-prototype

A React, Node.js/Express, and PostgreSQL application. The production environment is assumed to be Heroku.

Project file structure:

```
.
├── README.md
├── _helpers              # Back-end helper functions
├── _services             # Back-end services
├── app                   # React front-end
│   ├── README.md         # Front-end README generated by create-react-app
│   ├── package.json      # Front-end metadata
│   ├── public            # Front-end static files
│   └── src
│       ├── _helpers      # Front-end helper functions
│       ├── _services     # Front-end servers
│       ├── components    # Front-end components
|       ├── plugins       # Front-end CKEditor5 plugins
│       └── index.js      # Front-end entrypoint
├── db                    # Database files
│   ├── index.js          # Knex.js database connection
│   ├── migrations        # Database migrations
│   └── seeds             # Database seeds
├── knexfile.js           # Knex.js database configuration
├── package.json          # Back-end metadata
└── server.js             # Back-end entrypoint
```

## Local application setup

Clone this repository and install dependencies with: `npm i`

Using the template in `./.env.sample`, create a `./.env` file to hold environment variables. Add any secret string to the `JWT_SECRET` variable.

Run in development mode with: `npm run start:dev`

Create a build (with artifacts placed in `./app/build`) by running: `npm run build`

## Database setup for local development

PostgreSQL is used for data persistence through the `pg` package. Install [PostgreSQL](https://www.postgresql.org/) locally as desired, and then follow the instructions below to create an empty database that we will later seed.

1. Open the `psql` shell using the superuser and default database:

```sh
psql -d postgres
```

2. In `psql`, create the database user that will be used to create and access the database. The username and password you select should be saved in the environment variables `DB_USER` and `DB_PASSWORD` in `./.env`.

```sql
CREATE ROLE cms_user WITH LOGIN PASSWORD 'password';
ALTER ROLE cms_user CREATEDB;
```

3. Exit `psql`, and open the shell again using the newly created user:

```sh
\q
psql -d postgres -U cms_user
```

4. Create the new database. The database name should be saved in the environment variable `DB_DATABASE` in `./.env`.

```sql
CREATE DATABASE cms;
```

5. Check that `gen_random_uuid()` function is available in your PostgreSQL installation:

```sql
select gen_random_uuid()
```

If it's not available, add the pgcrypto dependency in the database as a superuser.

```sql
CREATE EXTENSION pgcrypto;
```

## Initial data seeding

[Knex.js](https://knexjs.org/#Migrations) is used as a SQL query builder, and for creating migrations and seeds. Migrations are written to be able to roll back or forward, dropping or creating tables.

To make migration or seed files while developing locally, `knex` must be installed globally: `npm install -g knex`

`knex` will look for configuration information in `./knexfile.js`. This project saves migrations and seeds in directories within `./db`.

### Run migrations

Forward to the latest configuration:

```sh
knex migrate:latest
```

Roll back the last migration:

```sh
knex migrate:rollback
```

Roll back all migrations:

```sh
knex migrate:rollback --all
```

### Create a new migration file

Create a new migration file with the slug `create_pages_table` in the file name:

```sh
knex migrate:make create_pages_table
```

### Run seeds

```sh
knex seed:run
```

### Create a new seed file

Create a new seed file with the slug `add_hello_world_page` in the file name:

```sh
knex seed:make add_hello_world_page
```

## Heroku database usage

This project assumes a production deployment on Heroku, but can be used anywhere. Note that the reference to `process.env.DATABASE_URL` in `production` node of `./knexfile.js` assumes that this environment variable will be available as it is on Heroku.

Depending on the Heroku Postgres database tier being used, it might be necessary to explicitly set SSL requirements. See [Configuring Free Heroku Node/PostgreSQL hosting with Knex](https://dpletzke.medium.com/configuring-free-heroku-node-postgresql-hosting-with-knex-b0e97a05c6af). Specifically, `heroku config:set PGSSLMODE=no-verify` might be necessary with the "Hobby" tier.

Run migrations on Heroku: `heroku run knex migrate:latest`

Run seeds on Heroku: `heroku run knex seed:run`
